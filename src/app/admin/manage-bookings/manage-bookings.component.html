<div class="booking-management-container">
  
  <!-- Loading Overlay -->
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="loading-spinner"></div>
  </div>

  <!-- Page Header -->
  <div class="page-header-section">
    <div class="header-content">
      <h1>Service Bookings</h1>
      <p>Manage and track all customer service bookings</p>
    </div>
    
    <button 
      class="new-booking-btn" 
      mat-raised-button 
      color="primary" 
      routerLink="/admin/add-booking"
    >
      <mat-icon>add</mat-icon>
      New Booking
    </button>
  </div>

  <!-- Stats Overview -->
  <div class="stats-grid">
    <div 
      class="stat-item" 
      [class.active]="currentFilterStatus === 'PENDING'"
      (click)="filterByStatus('PENDING')"
    >
      <div class="stat-icon pending">
        <mat-icon>schedule</mat-icon>
      </div>
      <div class="stat-details">
        <h3>{{getBookingCountByStatus('PENDING')}}</h3>
        <p>Pending Bookings</p>
      </div>
    </div>
    
    <div 
      class="stat-item" 
      [class.active]="currentFilterStatus === 'APPROVED'"
      (click)="filterByStatus('APPROVED')"
    >
      <div class="stat-icon approved">
        <mat-icon>check_circle</mat-icon>
      </div>
      <div class="stat-details">
        <h3>{{getBookingCountByStatus('APPROVED')}}</h3>
        <p>Approved Bookings</p>
      </div>
    </div>
    
    <div 
      class="stat-item" 
      [class.active]="currentFilterStatus === 'COMPLETED'"
      (click)="filterByStatus('COMPLETED')"
    >
      <div class="stat-icon completed">
        <mat-icon>done_all</mat-icon>
      </div>
      <div class="stat-details">
        <h3>{{getBookingCountByStatus('COMPLETED')}}</h3>
        <p>Completed</p>
      </div>
    </div>

    <div 
      class="stat-item" 
      [class.active]="currentFilterStatus === 'CANCELLED'"
      (click)="filterByStatus('CANCELLED')"
    >
      <div class="stat-icon cancelled">
        <mat-icon>cancel</mat-icon>
      </div>
      <div class="stat-details">
        <h3>{{getBookingCountByStatus('CANCELLED')}}</h3>
        <p>Cancelled</p>
      </div>
    </div>
    
    <div 
      class="stat-item" 
      [class.active]="currentFilterStatus === ''"
      (click)="filterByStatus('')"
    >
      <div class="stat-icon total">
        <mat-icon>event_note</mat-icon>
      </div>
      <div class="stat-details">
        <h3>{{dataSource.data.length}}</h3>
        <p>Total Bookings</p>
      </div>
    </div>
  </div>

  <!-- Controls Section -->
  <div class="controls-section">
    <div class="controls-grid">
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Search bookings...</mat-label>
        <input 
          matInput 
          [(ngModel)]="searchQuery" 
          (keyup)="applySearch()" 
          placeholder="Search by name, phone, or reference..."
          [disabled]="isLoading"
        >
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
      
      <div class="control-buttons">
        <button 
          mat-stroked-button 
          class="control-btn"
          (click)="clearFilters()"
          [disabled]="isLoading"
        >
          <mat-icon>filter_alt_off</mat-icon>
          Clear
        </button>
        
        <button 
          mat-stroked-button 
          class="control-btn"
          (click)="refreshBookings()"
          [disabled]="isLoading"
        >
          <mat-icon>refresh</mat-icon>
          Refresh
        </button>
        
        <button 
          mat-stroked-button 
          class="control-btn"
          (click)="exportToExcel()"
          [disabled]="isLoading"
        >
          <mat-icon>download</mat-icon>
          Export
        </button>
      </div>
    </div>
    
    <!-- Status Filter Chips -->
    <div class="status-filters" *ngIf="!isMobileView">
      <button 
        class="filter-chip" 
        [class.active]="currentFilterStatus === ''"
        (click)="filterByStatus('')"
      >
        All
      </button>
      <button 
        class="filter-chip" 
        [class.active]="currentFilterStatus === 'PENDING'"
        (click)="filterByStatus('PENDING')"
      >
        Pending
      </button>
      <button 
        class="filter-chip" 
        [class.active]="currentFilterStatus === 'APPROVED'"
        (click)="filterByStatus('APPROVED')"
      >
        Approved
      </button>
      <button 
        class="filter-chip" 
        [class.active]="currentFilterStatus === 'COMPLETED'"
        (click)="filterByStatus('COMPLETED')"
      >
        Completed
      </button>
      <button 
        class="filter-chip" 
        [class.active]="currentFilterStatus === 'CANCELLED'"
        (click)="filterByStatus('CANCELLED')"
      >
        Cancelled
      </button>
    </div>
  </div>

  <!-- Desktop Table View -->
  <div class="main-table-container" *ngIf="!isMobileView">
    <!-- Table Header -->
    <div class="table-header">
      <h2>All Bookings (Recent First)</h2>
      <div class="sort-info">
        <mat-icon>sort</mat-icon>
        Sorted by Reference (Newest First)
      </div>
    </div>

    <!-- Table Content -->
    <div class="table-content">
      <table class="booking-table" mat-table [dataSource]="dataSource" matSort>
        
        <!-- Customer Column -->
        <ng-container matColumnDef="customer">
          <th mat-header-cell *matHeaderCellDef>Customer</th>
          <td mat-cell *matCellDef="let booking">
            <div class="customer-info">
              <div class="customer-details">
                <h4>{{ booking.name }}</h4>
                <p class="customer-phone">
                  <mat-icon class="phone-icon">phone</mat-icon>
                  {{ booking.phone }}
                </p>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Reference Column -->
        <ng-container matColumnDef="reference">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Reference</th>
          <td mat-cell *matCellDef="let booking">
            <div class="reference-cell">
              <div class="reference-badge" (click)="copyReference(booking.reference || '')" matTooltip="Click to copy">
                <mat-icon>tag</mat-icon>
                <span class="reference-id">{{ booking.reference || 'N/A' }}</span>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Service Date Column -->
        <ng-container matColumnDef="serviceDate">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>
            <div class="date-header">
              <mat-icon>calendar_today</mat-icon>
              Service Date
            </div>
          </th>
          <td mat-cell *matCellDef="let booking">
            <div class="service-date-cell">
              <div class="service-date">
                <mat-icon>event</mat-icon>
                {{ booking.date | date: 'dd MMM yyyy' }}
              </div>
              <div class="date-difference">
                {{ getDaysUntilService(booking.date) }}
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Service Column -->
        <ng-container matColumnDef="service">
          <th mat-header-cell *matHeaderCellDef>Service Type</th>
          <td mat-cell *matCellDef="let booking">
            <span 
              class="service-badge" 
              [ngClass]="getServiceBadgeClass(booking.service)"
            >
              <mat-icon>{{ getServiceBadgeWithIcon(booking.service).icon }}</mat-icon>
              {{ getServiceName(booking.service) }}
            </span>
          </td>
        </ng-container>

        <!-- Additional Services Column -->
        <ng-container matColumnDef="additionalServices">
          <th mat-header-cell *matHeaderCellDef>Additional Services</th>
          <td mat-cell *matCellDef="let booking">
            <div *ngIf="booking.additionalServicesJson || booking.additionalServiceName">
              <div *ngFor="let svc of parseAdditionalServices(booking.additionalServicesJson)" style="background-color: #fff3cd; padding: 4px 8px; border-radius: 3px; font-size: 12px; display: inline-block; margin: 2px;">
                {{ svc.name }}
              </div>
              <span *ngIf="!booking.additionalServicesJson && booking.additionalServiceName" style="background-color: #fff3cd; padding: 4px 8px; border-radius: 3px; font-size: 12px; display: inline-block;">
                {{ booking.additionalServiceName }}
              </span>
            </div>
            <span *ngIf="!booking.additionalServiceName && !booking.additionalServicesJson" class="text-muted">No additional Service </span>
          </td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let booking" class="status-cell">
            <mat-form-field appearance="outline" class="status-select" [ngClass]="booking.status.toLowerCase()">
              <mat-select
                [value]="booking.status"
                (selectionChange)="updateStatus(booking, $event.value)"
                [disabled]="isLoading || isStatusLocked(booking.status)"
              >
                <mat-option value="PENDING" *ngIf="canShowStatus('PENDING', booking.status)">Pending</mat-option>
                <mat-option value="APPROVED" *ngIf="canShowStatus('APPROVED', booking.status)">Approved</mat-option>
                <mat-option value="COMPLETED" *ngIf="canShowStatus('COMPLETED', booking.status)">Completed</mat-option>
                <mat-option value="CANCELLED" *ngIf="canShowStatus('CANCELLED', booking.status)">Cancelled</mat-option>
              </mat-select>
              <mat-hint *ngIf="isStatusLocked(booking.status)" class="status-hint">
                {{ getStatusLockReason(booking.status) }}
              </mat-hint>
            </mat-form-field>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let booking">
            <button 
              mat-icon-button 
              color="primary" 
              (click)="viewAddress(booking)"
              matTooltip="View Address Details"
            >
              <mat-icon>visibility</mat-icon>
            </button>
          </td>
        </ng-container>

        <!-- Header Row -->
        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        
        <!-- Data Rows -->
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

      </table>
    </div>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="dataSource.filteredData.length === 0">
      <mat-icon class="empty-state-icon">event_busy</mat-icon>
      <h3>No Bookings Found</h3>
      <p *ngIf="searchQuery || currentFilterStatus">
        No bookings match your current search criteria. Try adjusting your filters.
      </p>
      <p *ngIf="!searchQuery && !currentFilterStatus">
        No bookings available. Create your first booking to get started.
      </p>
      <button 
        mat-stroked-button 
        (click)="clearFilters()"
        *ngIf="searchQuery || currentFilterStatus"
      >
        <mat-icon>clear_all</mat-icon>
        Clear Filters
      </button>
    </div>

    <!-- Paginator -->
    <mat-paginator 
      [pageSizeOptions]="[5, 10, 25, 50]" 
      showFirstLastButtons
      [length]="dataSource.filteredData.length"
      [pageSize]="10"
    >
    </mat-paginator>
  </div>

  <!-- Mobile Card View -->
  <div class="mobile-cards" *ngIf="isMobileView">
    <div class="mobile-card" *ngFor="let booking of dataSource.filteredData">
      <div class="mobile-card-header">
        <div class="mobile-avatar">
          {{getInitials(booking.name)}}
        </div>
        <div class="mobile-customer-info">
          <h4>{{ booking.name }}</h4>
          <p class="mobile-phone">
            <mat-icon class="phone-icon">phone</mat-icon>
            {{ booking.phone }}
          </p>
          <div class="mobile-reference" (click)="copyReference(booking.reference || '')">
            <mat-icon>tag</mat-icon>
            {{ booking.reference || 'N/A' }}
          </div>
          <span 
            class="mobile-service-badge" 
            [ngClass]="getServiceBadgeClass(booking.service)"
          >
            <!-- <mat-icon>{{ getServiceBadgeWithIcon(booking.service).icon }}</mat-icon> -->
            <!-- {{ getServiceName(booking.service) }} -->
          </span>
        </div>
      </div>
      
      <div class="mobile-card-content">
        <!-- Address Details -->
        <div class="mobile-section" *ngIf="booking.address">
          <div class="mobile-section-title">
            <mat-icon>location_on</mat-icon>
            Address Details
          </div>
          <div class="mobile-address-grid">
            <div class="mobile-address-row">
              <span class="mobile-address-label">House:</span>
              <span class="mobile-address-value">{{ getAddressPart(booking.address, 'house') }}</span>
            </div>
            <div class="mobile-address-row">
              <span class="mobile-address-label">Area:</span>
              <span class="mobile-address-value">{{ getAddressPart(booking.address, 'area') }}</span>
            </div>
            <div class="mobile-address-row">
              <span class="mobile-address-label">City:</span>
              <span class="mobile-address-value">{{ getAddressPart(booking.address, 'city') }}</span>
            </div>
            <div class="mobile-address-row">
              <span class="mobile-address-label">Pincode:</span>
              <span class="mobile-address-value">{{ getAddressPart(booking.address, 'pincode') }}</span>
            </div>
            <div class="mobile-address-row">
              <span class="mobile-address-label">Near:</span>
              <span class="mobile-address-value">{{ getAddressPart(booking.address, 'landmark') }}</span>
            </div>
          </div>
        </div>
        
        <!-- Service Details -->
        <div class="mobile-row">
          <span class="mobile-label">Service Date</span>
          <span class="mobile-value">
            {{ booking.date | date: 'dd MMM yyyy' }}
            <span class="date-diff">({{ getDaysUntilService(booking.date) }})</span>
          </span>
        </div>
        
        <!-- Status -->
        <div class="mobile-row">
          <span class="mobile-label">Status</span>
          <span class="mobile-value">
            <mat-form-field appearance="outline" class="status-select" [ngClass]="booking.status.toLowerCase()">
              <mat-select
                [value]="booking.status"
                (selectionChange)="updateStatus(booking, $event.value)"
                [disabled]="isLoading"
              >
                <mat-option value="PENDING" *ngIf="canShowStatus('PENDING', booking.status)">Pending</mat-option>
                <mat-option value="APPROVED" *ngIf="canShowStatus('APPROVED', booking.status)">Approved</mat-option>
                <mat-option value="COMPLETED" *ngIf="canShowStatus('COMPLETED', booking.status)">Completed</mat-option>
                <mat-option value="CANCELLED" *ngIf="canShowStatus('CANCELLED', booking.status)">Cancelled</mat-option>
              </mat-select>
            </mat-form-field>
          </span>
        </div>
      </div>
      
      <div class="mobile-actions">
        <button 
          *ngIf="booking.latLong" 
          class="mobile-action-btn mobile-map-btn" 
          (click)="openMap(booking.latLong)"
        >
          <img src="https://maps.gstatic.com/mapfiles/api-3/images/icon7.png" alt="Google Maps" class="google-maps-icon">
          View on Map
        </button>
       
      </div>
    </div>
    
    <!-- Mobile Empty State -->
    <div class="empty-state" *ngIf="dataSource.filteredData.length === 0">
      <mat-icon class="empty-state-icon">event_busy</mat-icon>
      <h3>No Bookings Found</h3>
      <p>No bookings match your current filters</p>
    </div>
  </div>

</div>